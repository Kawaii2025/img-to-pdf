<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è½¬PDFå·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            border-color: #666;
        }
        
        .upload-area.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
        
        .upload-area.disabled:hover {
            border-color: #ccc;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 15px;
        }
        
        #file-input {
            display: none;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            min-height: 160px;
        }
        
        .preview-item {
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: grab;
            transition: all 0.2s ease;
        }
        
        .preview-item:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            transition: all 0.2s ease;
        }
        
        .preview-item:hover img {
            transform: scale(1.05);
        }
        
        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #ff4444;
            z-index: 2;
        }
        
        .preview-item .order-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-item .preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 5px;
            font-size: 12px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .preview-item:hover .preview-overlay {
            opacity: 1;
        }
        
        .preview-item.dragging {
            opacity: 0.5;
            transform: scale(1.1);
        }
        
        .preview-item.drag-over {
            border: 2px dashed #2196F3;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        #convert-btn {
            background-color: #2196F3;
            color: white;
        }
        
        #clear-btn {
            background-color: #f44336;
            color: white;
        }
        
        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hint-text {
            text-align: center;
            color: #666;
            margin: 10px 0;
            font-size: 14px;
        }
        
        /* ä¸Šä¼ è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #2196F3;
            width: 0%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        /* å›¾ç‰‡é¢„è§ˆå¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            color: #ff4444;
        }
        
        .modal-info {
            position: absolute;
            bottom: -30px;
            left: 0;
            color: white;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .modal-info {
                bottom: -40px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å›¾ç‰‡è½¬PDFå·¥å…·</h1>
        
        <div class="upload-area" id="drop-area">
            <div class="upload-icon">ğŸ“</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
            <p style="margin-top: 10px; color: #666;">æ”¯æŒJPGã€PNGã€WEBPæ ¼å¼</p>
            <input type="file" id="file-input" accept="image/*" multiple>
        </div>
        
        <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-info">
                <span id="progress-text">å¤„ç†ä¸­: 0/0</span>
                <span id="progress-percentage">0%</span>
            </div>
        </div>
        
        <p class="hint-text">å¯ä»¥æ‹–æ‹½å›¾ç‰‡è°ƒæ•´é¡ºåºï¼Œç‚¹å‡»å›¾ç‰‡å¯æ”¾å¤§é¢„è§ˆå“¦ï¼</p>
        
        <div class="preview-container" id="preview-container"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨ç”ŸæˆPDF...</p>
        </div>
        
        <div class="controls">
            <button id="convert-btn">ç”ŸæˆPDF</button>
            <button id="clear-btn">æ¸…ç©º</button>
        </div>
    </div>
    
    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div class="modal" id="preview-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close">&times;</span>
            <img class="modal-image" id="modal-image" src="" alt="å¤§å›¾é¢„è§ˆ">
            <div class="modal-info" id="modal-info"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <script>
        const { PDFDocument, rgb } = PDFLib;
        
        // DOMå…ƒç´ 
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const convertBtn = document.getElementById('convert-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loading = document.getElementById('loading');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        const previewModal = document.getElementById('preview-modal');
        const modalImage = document.getElementById('modal-image');
        const modalClose = document.getElementById('modal-close');
        const modalInfo = document.getElementById('modal-info');
        
        // å­˜å‚¨ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶
        let imageFiles = [];
        let draggedItem = null;
        let isProcessing = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨å¤„ç†
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEvents() {
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            dropArea.addEventListener('click', () => {
                if (!isProcessing) {
                    fileInput.click();
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½äº‹ä»¶
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    if (!isProcessing) {
                        highlight(e);
                    }
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            // è½¬æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            convertBtn.addEventListener('click', convertImagesToPdf);
            
            // æ¸…ç©ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            clearBtn.addEventListener('click', () => {
                if (!isProcessing) {
                    clearAll();
                }
            });
            
            // åˆå§‹åŒ–æ‹–æ‹½æ’åºäº‹ä»¶
            initDragAndDrop();
            
            // å›¾ç‰‡é¢„è§ˆå¼¹çª—äº‹ä»¶
            initModalEvents();
        }
        
        // è®¾ç½®å¤„ç†çŠ¶æ€
        function setProcessingState(state) {
            isProcessing = state;
            
            if (state) {
                // ç¦ç”¨ä¸Šä¼ åŒºåŸŸ
                dropArea.classList.add('disabled');
                fileInput.disabled = true;
                
                // ç¦ç”¨æŒ‰é’®
                convertBtn.disabled = true;
                clearBtn.disabled = true;
            } else {
                // å¯ç”¨ä¸Šä¼ åŒºåŸŸ
                dropArea.classList.remove('disabled');
                fileInput.disabled = false;
                
                // å¯ç”¨æŒ‰é’®
                convertBtn.disabled = false;
                if (imageFiles.length === 0) {
                    clearBtn.disabled = true; // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œæ¸…ç©ºæŒ‰é’®ä¿æŒç¦ç”¨
                } else {
                    clearBtn.disabled = false;
                }
            }
        }
        
        // åˆå§‹åŒ–æ‹–æ‹½æ’åºåŠŸèƒ½
        function initDragAndDrop() {
            previewContainer.addEventListener('dragstart', handleDragStart);
            previewContainer.addEventListener('dragover', handleDragOver);
            previewContainer.addEventListener('dragenter', handleDragEnter);
            previewContainer.addEventListener('dragleave', handleDragLeave);
            previewContainer.addEventListener('drop', handleDropItem);
            previewContainer.addEventListener('dragend', handleDragEnd);
        }
        
        // åˆå§‹åŒ–é¢„è§ˆå¼¹çª—äº‹ä»¶
        function initModalEvents() {
            // å…³é—­å¼¹çª—
            modalClose.addEventListener('click', closeModal);
            
            // ç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸå…³é—­
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) {
                    closeModal();
                }
            });
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && previewModal.style.display === 'flex') {
                    closeModal();
                }
            });
        }
        
        // æ‰“å¼€é¢„è§ˆå¼¹çª—
        function openModal(src, fileInfo, index) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢é¢„è§ˆ
            
            modalImage.src = src;
            modalInfo.textContent = `å›¾ç‰‡ ${index + 1}/${imageFiles.length} | ${fileInfo.name} | ${formatFileSize(fileInfo.size)}`;
            previewModal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        }
        
        // å…³é—­é¢„è§ˆå¼¹çª—
        function closeModal() {
            previewModal.style.display = 'none';
            document.body.style.overflow = 'auto'; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ‹–æ‹½å¼€å§‹
        function handleDragStart(e) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢æ‹–æ‹½
            
            if (e.target.closest('.preview-item')) {
                draggedItem = e.target.closest('.preview-item');
                draggedItem.classList.add('dragging');
                e.dataTransfer.setData('text/plain', draggedItem.dataset.index);
                e.dataTransfer.effectAllowed = 'move';
            }
        }
        
        // æ‹–æ‹½è¿‡ç¨‹ä¸­
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        // è¿›å…¥æ‹–æ‹½ç›®æ ‡
        function handleDragEnter(e) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢æ‹–æ‹½
            
            const targetItem = e.target.closest('.preview-item');
            if (targetItem && targetItem !== draggedItem) {
                targetItem.classList.add('drag-over');
            }
        }
        
        // ç¦»å¼€æ‹–æ‹½ç›®æ ‡
        function handleDragLeave(e) {
            const targetItem = e.target.closest('.preview-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }
        
        // æ”¾ç½®æ‹–æ‹½é¡¹
        function handleDropItem(e) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢æ‹–æ‹½
            
            e.preventDefault();
            
            const targetItem = e.target.closest('.preview-item');
            if (!targetItem || !draggedItem || targetItem === draggedItem) return;
            
            // è·å–ç´¢å¼•
            const draggedIndex = parseInt(draggedItem.dataset.index);
            const targetIndex = parseInt(targetItem.dataset.index);
            
            // æ›´æ–°æ•°ç»„é¡ºåº
            const draggedFile = imageFiles[draggedIndex];
            imageFiles.splice(draggedIndex, 1);
            imageFiles.splice(targetIndex, 0, draggedFile);
            
            // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            renderPreviewItems();
        }
        
        // æ‹–æ‹½ç»“æŸ
        function handleDragEnd() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            const allItems = document.querySelectorAll('.preview-item');
            allItems.forEach(item => item.classList.remove('drag-over'));
            draggedItem = null;
        }
        
        // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¢„è§ˆé¡¹
        function renderPreviewItems() {
            previewContainer.innerHTML = '';
            imageFiles.forEach(async (file, index) => {
                await createPreview(file, index);
            });
            
            // æ›´æ–°æ¸…ç©ºæŒ‰é’®çŠ¶æ€
            clearBtn.disabled = imageFiles.length === 0;
        }
        
        // æ›´æ–°ä¸Šä¼ è¿›åº¦
        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `å¤„ç†ä¸­: ${current}/${total}`;
            progressPercentage.textContent = `${percent}%`;
            
            // å¤„ç†å®Œæˆåéšè—è¿›åº¦æ¡å¹¶æ¢å¤çŠ¶æ€
            if (current >= total) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    setProcessingState(false); // æ¢å¤å¯æ“ä½œçŠ¶æ€
                }, 500);
            }
        }
        
        // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // é«˜äº®ä¸Šä¼ åŒºåŸŸ
        function highlight(e) {
            if (!isProcessing) {
                dropArea.style.borderColor = '#2196F3';
                dropArea.style.backgroundColor = '#e3f2fd';
            }
        }
        
        // å–æ¶ˆé«˜äº®
        function unhighlight() {
            dropArea.style.borderColor = '#ccc';
            dropArea.style.backgroundColor = 'white';
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢ä¸Šä¼ 
            
            const files = e.target.files;
            if (files) {
                handleFiles(files);
            }
        }
        
        // å¤„ç†æ‹–æ‹½æ–‡ä»¶
        function handleDrop(e) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢ä¸Šä¼ 
            
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        async function handleFiles(files) {
            const fileList = Array.from(files).filter(file => file.type.startsWith('image/'));
            const totalFiles = fileList.length;
            
            if (totalFiles === 0) return;
            
            // è®¾ç½®å¤„ç†çŠ¶æ€ä¸ºtrueï¼Œç¦ç”¨ä¸Šä¼ 
            setProcessingState(true);
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressContainer.style.display = 'block';
            updateProgress(0, totalFiles);
            
            // å¤„ç†æ¯å¼ å›¾ç‰‡
            for (let i = 0; i < totalFiles; i++) {
                const file = fileList[i];
                
                // æ›´æ–°è¿›åº¦
                updateProgress(i, totalFiles);
                
                // å‹ç¼©å›¾ç‰‡
                const options = {
                    maxSizeMB: 1, // æœ€å¤§1MB
                    maxWidthOrHeight: 1920,
                    useWebWorker: true
                };
                
                try {
                    const compressedFile = await imageCompression(file, options);
                    imageFiles.push(compressedFile);
                    await createPreview(compressedFile, imageFiles.length - 1);
                } catch (error) {
                    console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
                    imageFiles.push(file);
                    await createPreview(file, imageFiles.length - 1);
                }
            }
            
            // æ›´æ–°æœ€ç»ˆè¿›åº¦
            updateProgress(totalFiles, totalFiles);
        }
        
        // åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
        function createPreview(file, index) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.dataset.index = index;
                    previewItem.draggable = !isProcessing; // å¤„ç†ä¸­æ—¶ç¦æ­¢æ‹–æ‹½
                    
                    previewItem.innerHTML = `
                        <div class="order-number">${index + 1}</div>
                        <img src="${e.target.result}" alt="é¢„è§ˆå›¾ç‰‡">
                        <div class="preview-overlay">ç‚¹å‡»æŸ¥çœ‹å¤§å›¾</div>
                        <button class="remove-btn" data-index="${index}" ${isProcessing ? 'disabled' : ''}>Ã—</button>
                    `;
                    
                    // ç‚¹å‡»å›¾ç‰‡é¢„è§ˆå¤§å›¾
                    const imgElement = previewItem.querySelector('img');
                    imgElement.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‹–æ‹½
                        openModal(e.target.src, file, index);
                    });
                    
                    // åˆ é™¤æŒ‰é’®äº‹ä»¶
                    const removeBtn = previewItem.querySelector('.remove-btn');
                    removeBtn.addEventListener('click', function(e) {
                        if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢åˆ é™¤
                        
                        e.stopPropagation(); // é˜²æ­¢è§¦å‘é¢„è§ˆ
                        const idx = parseInt(this.dataset.index);
                        removeImage(idx);
                    });
                    
                    previewContainer.appendChild(previewItem);
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }
        
        // ç§»é™¤å›¾ç‰‡
        function removeImage(index) {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢åˆ é™¤
            
            // ä»æ•°ç»„ä¸­ç§»é™¤
            imageFiles.splice(index, 1);
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¢„è§ˆé¡¹ä»¥æ›´æ–°ç´¢å¼•
            renderPreviewItems();
        }
        
        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (isProcessing) return; // å¤„ç†ä¸­æ—¶ç¦æ­¢æ¸…ç©º
            
            imageFiles = [];
            previewContainer.innerHTML = '';
            progressContainer.style.display = 'none';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            clearBtn.disabled = true;
        }
        
        // å°†å›¾ç‰‡è½¬æ¢ä¸ºPDF
        async function convertImagesToPdf() {
            if (imageFiles.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }
            
            // è®¾ç½®å¤„ç†çŠ¶æ€ä¸ºtrueï¼Œç¦ç”¨æ‰€æœ‰æ“ä½œ
            setProcessingState(true);
            
            loading.style.display = 'block';
            
            try {
                // åˆ›å»ºæ–°çš„PDFæ–‡æ¡£
                const pdfDoc = await PDFDocument.create();
                
                // å¤„ç†æ¯å¼ å›¾ç‰‡ï¼ˆæŒ‰ç…§å½“å‰é¡ºåºï¼‰
                for (let i = 0; i < imageFiles.length; i++) {
                    const imageFile = imageFiles[i];
                    
                    // è¯»å–å›¾ç‰‡æ•°æ®
                    const imageBytes = await readFileAsArrayBuffer(imageFile);
                    
                    // æ ¹æ®å›¾ç‰‡ç±»å‹åµŒå…¥åˆ°PDF
                    let image;
                    if (imageFile.type === 'image/jpeg' || imageFile.type === 'image/jpg') {
                        image = await pdfDoc.embedJpg(imageBytes);
                    } else if (imageFile.type === 'image/png') {
                        image = await pdfDoc.embedPng(imageBytes);
                    } else if (imageFile.type === 'image/webp') {
                        // è½¬æ¢WebPä¸ºPNG
                        const pngImage = await convertWebpToPng(imageFile);
                        image = await pdfDoc.embedPng(pngImage);
                    } else {
                        console.warn(`ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼: ${imageFile.type}`);
                        continue;
                    }
                    
                    // è·å–å›¾ç‰‡å°ºå¯¸
                    const { width, height } = image.scale(1);
                    
                    // åˆ›å»ºé¡µé¢ï¼Œå¤§å°ä¸å›¾ç‰‡åŒ¹é…
                    const page = pdfDoc.addPage([width, height]);
                    
                    // å°†å›¾ç‰‡ç»˜åˆ¶åˆ°é¡µé¢
                    page.drawImage(image, {
                        x: 0,
                        y: 0,
                        width: width,
                        height: height,
                    });
                }
                
                // ä¿å­˜PDF
                const pdfBytes = await pdfDoc.save();
                
                // ä¸‹è½½PDFæ–‡ä»¶
                downloadFile(pdfBytes, 'å›¾ç‰‡æ‹¼æ¥.pdf', 'application/pdf');
                
            } catch (error) {
                console.error('ç”ŸæˆPDFå¤±è´¥:', error);
                alert('ç”ŸæˆPDFå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            } finally {
                loading.style.display = 'none';
                setProcessingState(false); // æ¢å¤å¯æ“ä½œçŠ¶æ€
            }
        }
        
        // å°†æ–‡ä»¶è¯»å–ä¸ºArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }
        
        // è½¬æ¢WebPä¸ºPNG
        function convertWebpToPng(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsArrayBuffer(blob);
                    }, 'image/png');
                };
                img.src = URL.createObjectURL(file);
            });
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(bytes, fileName, mimeType) {
            const blob = new Blob([bytes], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        initEvents();
        
        // åˆå§‹çŠ¶æ€ï¼šå¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œæ¸…ç©ºæŒ‰é’®ç¦ç”¨
        clearBtn.disabled = true;
    </script>
</body>
</html>
